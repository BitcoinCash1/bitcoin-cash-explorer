<div class="container-xl">
  <div class="title-block">
    <ng-container *ngIf="tx">
      <h1 i18n="shared.transaction">Transaction</h1>

      <span class="tx-link">
        <span class="txid">
          <app-truncate
            [text]="txId"
            [lastChars]="12"
            [link]="['/tx/' | relativeUrl, txId]"
          >
            <app-clipboard [text]="txId"></app-clipboard>
          </app-truncate>
        </span>
      </span>

      <div class="container-buttons">
        <app-confirmations
          *ngIf="tx"
          [chainTip]="latestBlock?.height"
          [height]="tx?.status?.block_height"
          [removed]="!this.tx?.status?.confirmed"
          [cached]="isCached"
        ></app-confirmations>
      </div>
    </ng-container>
  </div>
  <div class="clearfix"></div>

  @if (duplicateTxBlocks) {
    <div class="box duplicate-tx-alert">
      <div class="icon-container">
        <fa-icon [icon]="['fas', 'info-circle']" [fixedWidth]="true"></fa-icon>
      </div>
      <span>
        <ng-container
          i18n="transaction.duplicate.notice|Duplicate transaction notice"
        >
          This transaction ID appears twice in the blockchain as the coinbase of
          blocks
          <a [routerLink]="['/block/' | relativeUrl, duplicateTxBlocks[0]]">{{
            duplicateTxBlocks[0]
          }}</a>
          and
          <a [routerLink]="['/block/' | relativeUrl, duplicateTxBlocks[1]]">{{
            duplicateTxBlocks[1]
          }}</a
          >, due to a bug later mitigated by
          <a
            href="https://github.com/bitcoin/bips/blob/master/bip-0030.mediawiki"
            target="_blank"
            rel="noopener"
            >BIP-30</a
          >.
        </ng-container>
        <span class="mr-3"></span>
        <a
          href="https://blog.bitmex.com/bitcoins-duplicate-transactions/"
          target="_blank"
          rel="noopener"
          i18n="transaction.duplicate.read-more|Duplicate transaction read more"
          style="white-space: nowrap"
          >Read more</a
        >
      </span>
    </div>
  }
  @if (!error) {
    <app-transaction-details
      [network]="network"
      [tx]="tx"
      [isLoadingTx]="isLoadingTx"
      [isMobile]="isMobile"
      [transactionTime]="transactionTime"
      [isLoadingFirstSeen]="isLoadingFirstSeen"
      [auditStatus]="auditStatus"
      [filters]="filters"
      [miningStats]="miningStats"
      [pool]="pool"
      [hasEffectiveFeeRate]="hasEffectiveFeeRate"
      [isCached]="isCached"
      [ETA$]="ETA$"
    ></app-transaction-details>
  }

  <ng-template [ngIf]="!isLoadingTx && !error">
    <ng-container *ngIf="flowEnabled; else flowPlaceholder">
      <div class="title float-left">
        <h2
          id="flow"
          #flow
          class="anchor"
          i18n="transaction.flow|Transaction flow"
        >
          Flow
        </h2>
      </div>

      <button
        type="button"
        class="btn btn-outline-info flow-toggle btn-sm float-right"
        (click)="toggleGraph()"
        i18n="hide-diagram"
      >
        Hide diagram
      </button>

      <div class="clearfix"></div>

      <div class="box">
        <div class="graph-container" #graphContainer>
          <tx-bowtie-graph
            [tx]="tx"
            [cached]="isCached"
            [width]="graphWidth"
            [height]="graphHeight"
            [lineLimit]="inOutLimit"
            [maxStrands]="graphExpanded ? maxInOut : 24"
            [network]="network"
            [tooltip]="true"
            [connectors]="true"
            [inputIndex]="inputIndex"
            [outputIndex]="outputIndex"
          >
          </tx-bowtie-graph>
        </div>
        <div class="toggle-wrapper" *ngIf="maxInOut > 24">
          <button
            class="btn btn-sm btn-primary graph-toggle"
            (click)="expandGraph()"
            *ngIf="!graphExpanded; else collapseBtn"
          >
            <span i18n="show-more">Show more</span>
          </button>
          <ng-template #collapseBtn>
            <button
              class="btn btn-sm btn-primary graph-toggle"
              (click)="collapseGraph()"
            >
              <span i18n="show-less">Show less</span>
            </button>
          </ng-template>
        </div>
      </div>

      <br />
    </ng-container>
    <ng-template #flowPlaceholder>
      <div class="box hidden">
        <div class="graph-container" #graphContainer></div>
      </div>
    </ng-template>

    <div class="subtitle-block">
      <div class="title">
        <h2
          i18n="transaction.inputs-and-outputs|Transaction inputs and outputs"
        >
          Inputs & Outputs
        </h2>
      </div>

      <div class="title-buttons">
        <button
          *ngIf="!flowEnabled"
          type="button"
          class="btn btn-outline-info flow-toggle btn-sm"
          (click)="toggleGraph()"
          i18n="show-diagram"
        >
          Show diagram
        </button>
        <button
          type="button"
          class="btn btn-outline-info btn-sm"
          (click)="txList.toggleDetails()"
          i18n="transaction.details|Transaction Details"
        >
          Details
        </button>
      </div>
    </div>

    <app-transactions-list
      #txList
      [transactions]="[tx]"
      [cached]="isCached"
      [errorUnblinded]="errorUnblinded"
      [inputIndex]="inputIndex"
      [outputIndex]="outputIndex"
      [transactionPage]="true"
    ></app-transactions-list>

    <div class="title text-left">
      <h2 i18n="transaction.details|Transaction Details">Details</h2>
    </div>
    <div class="box">
      <div class="row">
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td i18n="transaction.size|Transaction Size">Size</td>
                <td [innerHTML]="'&lrm;' + (tx.size | bytes: 2)"></td>
              </tr>
              <tr *ngIf="adjustedSize != null">
                <td>
                  <ng-container
                    i18n="transaction.adjusted-size|Transaction Adjusted Size"
                    >Adjusted size</ng-container
                  >
                  <a
                    class="info-link"
                    [routerLink]="['/docs/faq/' | relativeUrl]"
                    fragment="what-is-adjusted-size"
                  >
                    <fa-icon
                      [icon]="['fas', 'info-circle']"
                      [fixedWidth]="true"
                    ></fa-icon>
                  </a>
                </td>
                <td [innerHTML]="'&lrm;' + (adjustedSize | bytes: 2)"></td>
              </tr>
              <tr>
                <td i18n="transaction.size">Size</td>
                <td [innerHTML]="'&lrm;' + (tx.size | bytes: 2)"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td i18n="transaction.version">Version</td>
                <td [innerHTML]="'&lrm;' + (tx.version | number)"></td>
              </tr>
              <tr>
                <td i18n="transaction.locktime">Locktime</td>
                <td [innerHTML]="'&lrm;' + (tx.locktime | number)"></td>
              </tr>
              <tr *ngIf="sigops != null">
                <td>
                  <ng-container i18n="transaction.sigops|Transaction Sigops"
                    >Sigops</ng-container
                  >
                  <a
                    class="info-link"
                    [routerLink]="['/docs/faq/' | relativeUrl]"
                    fragment="what-are-sigops"
                  >
                    <fa-icon
                      [icon]="['fas', 'info-circle']"
                      [fixedWidth]="true"
                    ></fa-icon>
                  </a>
                </td>
                <td [innerHTML]="'&lrm;' + (sigops | number)"></td>
              </tr>
              <tr>
                <td i18n="transaction.hex">Transaction hex</td>
                <td>
                  <a
                    target="_blank"
                    href="{{ network === '' ? '' : '/' + network }}/api/tx/{{
                      txId
                    }}/hex"
                    ><fa-icon
                      [icon]="['fas', 'external-link-alt']"
                      [fixedWidth]="true"
                    ></fa-icon
                  ></a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template [ngIf]="(isLoadingTx && !error) || loadingCachedTx">
    <br />
    <ng-container *ngIf="flowEnabled">
      <div class="title">
        <h2 i18n="transaction.flow|Transaction flow">Flow</h2>
      </div>

      <div class="box">
        <div
          class="graph-container"
          #graphContainer
          style="visibility: hidden"
        ></div>
        <div class="row">
          <div class="col-sm">
            <table class="table table-borderless table-striped">
              <tbody>
                <tr>
                  <td><span class="skeleton-loader"></span></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="col-sm">
            <table class="table table-borderless table-striped">
              <tbody>
                <tr>
                  <td><span class="skeleton-loader"></span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <br />
    </ng-container>

    <div class="title">
      <h2 i18n="transaction.inputs-and-outputs|Transaction inputs and outputs">
        Inputs & Outputs
      </h2>
    </div>

    <div class="box">
      <div class="row">
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td><span class="skeleton-loader"></span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td><span class="skeleton-loader"></span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <br />

    <div class="title">
      <h2 i18n="transaction.details|Transaction Details">Details</h2>
    </div>

    <div class="box">
      <div class="row">
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-sm">
          <table class="table table-borderless table-striped">
            <tbody>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
              <tr>
                <td><span class="skeleton-loader"></span></td>
                <td><span class="skeleton-loader"></span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template [ngIf]="error && !loadingCachedTx">
    <div class="text-center" *ngIf="waitingForTransaction; else errorTemplate">
      <h3 i18n="transaction.error.transaction-not-found">
        Transaction not found.
      </h3>
      <h5 i18n="transaction.error.waiting-for-it-to-appear">
        Waiting for it to appear in the mempool...
      </h5>
      <div class="spinner-border text-light mt-2"></div>
    </div>

    <ng-template #errorTemplate>
      <app-http-error [error]="error">
        <span i18n="transaction.error.loading-transaction-data"
          >Error loading transaction data.</span
        >
      </app-http-error>
    </ng-template>
  </ng-template>
</div>
